# 為替トレードバックテスト検証ツール

（7/4 現時点ではgeminiにAIを作ってもらった段階です。7月中旬頃にはさらに詳しく正確なREADMEを公開できるようにします）
（また、2GBでは収まらないcsvデータが多く含まれており、LFSでもpush失敗となったのでデータ類はリポジトリにありません。csvを証券会社からダウンロードして、pklファイル変換が必要です）

## 概要

このプロジェクトは、外国為替（FX）市場における特定の取引戦略の有効性を検証するためのバックテストツール、および将来的なリアルタイム取引への拡張を目的とした自動売買システムです。

主な特徴として、単純なゴールデンクロスやデッドクロスのような一般的なシグナルに依存せず、複数のテクニカル指標（移動平均線、ピボット、フィボナッチリトレースメント）とセッション情報を組み合わせた、より複合的な条件でエントリーポイントを判断するロジックを検証しています。

また、大量の過去データを用いた高速なバックテストを実現するため、データ形式の工夫（Pickle化）、並列処理による計算の高速化、NumPy/Pandasライブラリによるベクトル演算など、パフォーマンスを重視した設計がなされています。

## 主な特徴

-   **複合的なエントリーロジック**: 複数のテクニカル指標を組み合わせた、独自の押し目買い・戻り売り戦略を検証します。
-   **高速バックテスト**: NumPyによるベクトル演算、並列処理、データキャッシングにより、大量のデータでも高速に検証できます。
-   **セッション分析**: 東京、ロンドン、ニューヨークといった主要市場のセッション時間に基づいた分析機能を持ちます。
-   **柔軟なデータ管理**: CSVデータから高速なPickle形式への変換機能を備えています。
-   **詳細なログ出力**: トレードごとの詳細なログをCSVファイルに出力し、詳細な分析が可能です。

## 取引戦略について

このツールで検証しているのは、単純なトレンドフォロー戦略ではありません。主なアイデアは以下の通りです。

**「短期的な相場の過熱感や調整局面を狙った、押し目買い・戻り売り戦略」**

具体的なエントリー条件は、以下のような複数の要素を組み合わせて判断されます。

1.  **トレンドの方向性**: 中長期の移動平均線（例: 75MA）を用いて、全体的なトレンドの方向を把握します。
2.  **エントリーのタイミング**:
    -   短期の移動平均線（例: 20MA）とローソク足の位置関係から、短期的な調整局面（押し目・戻り）を判断します。
    -   これは、**ゴールデンクロスを待つのではなく、トレンド方向に価格が一時的に調整したタイミングを狙う**という工夫点です。
3.  **サポート＆レジスタンス**:
    -   **ピボット (Pivot Points)**: 前日の価格から計算されるサポートラインとレジスタンスライン。
    -   **フィボナッチ・リトレースメント (Fibonacci Retracement)**: 直近の高値・安値から計算される押し目・戻りの目安。
    -   これらのライン付近での反発をエントリーの根拠として加えます。
4.  **セッション情報**: 特定の市場（例: ロンドン市場）が開いている時間帯はボラティリティが高まる傾向があるため、セッション情報をエントリー条件の一��として考慮します。

これらの条件を複合的に組み合わせることで、より精度の高いエントリーポイントを探ることを目的としています。

## セットアップと実行方法

### 1. 前提条件

-   Python 3.8以上
-   必要なライブラリ: `pandas`, `numpy`など。（`requirements.txt`がないため、必要に応じてインストールしてください）

### 2. リポジトリのクローン

```bash
git clone https://github.com/neoaamu2000/forex_old.git
cd forex_old
```

### 3. データ（Pickleファイル）の準備

**重要**: このリポジトリには、バックテストを高速に実行するための`pickle`形式のデータファイルは含まれていません。初回実行前、またはCSVデータを更新した際には、必ずデータ変換処理を実行する必要があります。

`test_file/currency_data/`内に配置されている`USDJPY_data.csv`などのソースデータから、`manage_data.py`などのデータ管理スクリプトを用いて`pickle`ファイルを生成します。

```bash
# manage_data.pyやそれに類するスクリプトでデータ変換を実行する例
python manage_data.py --convert-to-pickle
```

これにより、`test_file/pickle_data/`ディレクトリ内に、処理済みのデータが保存され、バックテスト時に高速に読み込めるようになります。

## 処理フロー

バックテストは主に以下の流れで実行されます。各処理はモジュール化されており、それぞれが特定の役割を担っています。

1.  **データ読み込み (`manage_data.py`)**:
    -   準備された`pickle`ファイルを読み込み、`pandas.DataFrame`としてメモリに展開します。
    -   データの日時、四本値などを適切な型に変換します。

2.  **テクニカル指標の計算**:
    -   **`SMA_highlow_functions.py`**: 指定された期間の移動平均線（SMA）を計算します。高値・安値ベースのSMA計算も含まれます。
    -   **`fibonacci_functions.py`**: DataFrameから高値・安値を検出し、フィボナッチ・リトレースメントの各レベル（23.6%, 38.2%, 61.8%など）を計算します。
    -   **`pivots.py`**: 前日の四本値から当���のピボットポイントおよびサポート・レジスタンスラインを計算します。

3.  **セッション情報の付与 (`session.py`)**:
    -   各時間にどの市場が開いているか（東京、ロンドン、ニューヨーク）の情報をデータに付与します。

4.  **エントリー・エグジット条件の判定 (`main.py`, `entry_condition.py`)**:
    -   DataFrameの各行（各時間足）に対して、前述の取引戦略に基づきエントリー条件が満たされているかを判定します。
    -   条件が満たされた場合、トレードログにエントリー情報を記録します。
    -   利確・損切りの条件を判定し、手仕舞いの処理を行います。

5.  **結果の集計と出力**:
    -   すべてのトレードが完了した後、トレードログ（`trade_logs.csv`など）をCSVファイルとして出力します。
    -   プロフィットファクター、勝率、総損益などのパフォーマンス指標を計算・表示します。

## パフォーマンス向上のための工夫

このプロジェクトでは、高速な検証サイク���を実現するために、以下の技術的な工夫が施されています。

### 1. NumPy/Pandasによるベクトル演算

-   金融データのような大規模な時系列データを扱う際、Python標準の`for`ループで各行を処理すると非常に低速になります。
-   本プロジェクトでは、`NumPy`および`Pandas`ライブラリを全面的に活用しています。これにより、移動平均の計算や条件判定などを「ベクトル演算」として一括で処理できます。
-   ベクトル演算は、内部的にC言語などの高速な言語で実装されているため、ループ処理に比べて数十倍から数百倍高速に動作します。

### 2. 並列処理による計算高速化

-   バックテスト、特にパラメータの最適化を行う際には、膨大な量の計算が必要です。
-   `test_file/main_parallels.py`からわかるように、`multiprocessing`などのライブラリを利用して、計算処理を複数のCPUコアに分散させています。
-   これにより、異なる通貨ペアや異なるパラメータ設定のバックテストを同��に実行でき、全体の検証時間を劇的に短縮します。

### 3. データキャッシング（Pickle形式の利用）

-   数十MBから数百MBになることもあるCSVファイルは、テキスト形式であるため、プログラム実行のたびに解析（パース）に時間がかかります。
-   `pickle`は、Pythonオブジェクトをバイナリ形式でシリアライズ（保存）するための仕組みです。
-   一度`DataFrame`オブジェクトとして読み込んだデータを`pickle`ファイルとして保存しておくことで、次回以降はテキストの解析が不要になり、データの読み込み時間を大幅に短縮できます。

## ディレクトリ構成

-   `リアルタイム本番用/`: 実際の取引口座と連携して動作させるための本番用コードが格納されています。
-   `test_file/`: バックテストに関連するファイル群。データ、テスト用スクリプト、検証結果などが含まれます。
-   `セッション開発用ファイル/`: 市場セッションに関連する機能の開発・検証用ファイルが格納され���います。
-   `アーカイブ/`: 過去のバージョンのコードや、実験的に作成したスクリプトが保管されています。
-   `矢印表示用/`: `matplotlib`などを利用して、チャート上に売買シグナルを矢印で表示するためのスクリプトです。